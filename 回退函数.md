# 回退函数

> 本文介绍了 Solidity 中的回退函数（fallback function）及其使用。

## 示例

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Fallback {
    event Log(uint gas);
    
    // 回退函数
    fallback() external payable {
        // 记录当前剩余的 gas
        emit Log(gasleft());
    }
}
```

在上面的示例中，我们定义了一个名为 `Fallback` 的合约，并使用 `fallback()` 函数作为其回退函数。如果合约收到任何未知的函数调用，则将调用该回退函数。

回退函数是可选的，但是如果合约没有定义其他函数可以处理接收到的消息，那么默认情况下，Solidity 将尝试调用合约的回退函数。

请注意，我们使用 `payable` 关键字来标识该函数允许接收以太币，并使用 `gasleft()` 函数来获取当前剩余的 gas 数量。

## 详解

### 回退函数概述

回退函数是一种特殊的函数，用于处理未知函数调用或向合约发送以太币而没有提供其他函数名称的情况。如果合约没有定义其他函数可以处理接收到的消息，那么默认情况下，Solidity 将尝试调用合约的回退函数。

回退函数有两种类型：空的回退函数和带有代码的回退函数：

- 空的回退函数：当没有其他可调用的函数可以处理发送到合约地址的消息时，将触发空的回退函数。这种回退函数不包含任何代码，并且不能接受以太币。
- 带有代码的回退函数：当没有其他可调用的函数可以处理发送到合约地址的消息时，将触发带有代码的回退函数。带有代码的回退函数可以接受以太币，并包含处理未知消息的代码。

### 回退函数与其他函数的关系

回退函数不应与其他函数混淆，因为它们具有不同的目的和行为。其他函数仅在接收到明确的函数调用时才会被调用，而回退函数仅在没有其他可调用的函数可以处理发送到合约地址的消息时才会被调用。

程序员应该小心使用回退函数，并确保在必要时提供带有代码的回退函数来处理未知的消息。

### `payable` 关键字

使用 `payable` 关键字来标识一个函数可以接收以太币。

```solidity
function myFunction() external payable {
    // 处理接收到的以太币
}
```

在上面的示例中，我们使用 `payable` 关键字来标识 `myFunction()` 函数可以接收以太币。请注意，只有具有 `payable` 修饰符的函数才能接收以太币。

### `gasleft()` 函数

使用 `gasleft()` 函数来获取当前剩余的 gas 数量。

```solidity
uint gas = gasleft();
```

在上面的示例中，我们将当前剩余的 gas 数量存储在名为 `gas` 的变量中，以便后续处理。

## 总结

回退函数是 Solidity 中特殊的函数之一，用于处理未知的函数调用或向合约发送以太币而没有提供其他函数名称的情况。程序员可以使用回退函数来处理这些情况，并确保在必要时提供带有代码的回退函数来处理未知的消息。通过使用 `payable` 关键字和 `gasleft()` 函数，程序员可以方便地处理以太币和 gas 相关逻辑，并确保正确地处理未知消息。